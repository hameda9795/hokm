name: Deploy to Hetzner

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment variables
        run: |
          echo "DEPLOYMENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Deploy to Hetzner Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            # Navigate to project directory
            cd /opt/hokm
            
            # Pull latest changes
            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin main
            
            # Create .env file if not exists
            if [ ! -f .env ]; then
              echo "ðŸ“ Creating .env file..."
              cat > .env << EOF
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            TELEGRAM_WEBHOOK_DOMAIN=https://hokm.maxhmd.dev
            NODE_ENV=production
            EOF
            fi
            
            # Build and restart containers
            echo "ðŸ—ï¸  Building Docker containers..."
            docker-compose build --no-cache
            
            echo "ðŸ”„ Restarting services..."
            docker-compose down
            docker-compose up -d
            
            # Health check
            echo "ðŸ¥ Waiting for services to start..."
            sleep 10
            
            # Check if services are running
            if docker-compose ps | grep -q "Up"; then
              echo "âœ… Services are running"
            else
              echo "âŒ Services failed to start"
              docker-compose logs --tail=50
              exit 1
            fi

            # Update Nginx Configuration
            echo "ðŸ”§ Updating Nginx configuration..."
            cp nginx-system-config.conf /etc/nginx/sites-available/hokm.conf
            ln -sf /etc/nginx/sites-available/hokm.conf /etc/nginx/sites-enabled/
            
            # Test and Reload Nginx
            if nginx -t; then
              echo "âœ… Nginx configuration valid"
              systemctl reload nginx
              echo "ðŸ”„ Nginx reloaded"
            else
              echo "âŒ Invalid Nginx configuration"
              exit 1
            fi

            echo "âœ… Deployment successful!"
            echo "ðŸ“¦ Commit: ${GITHUB_SHA:0:7}"
              echo "â° Time: $(date +'%Y-%m-%d %H:%M:%S')"
            else
              echo "âŒ Deployment failed - services not running"
              docker-compose logs --tail=50
              exit 1
            fi
            
            # Cleanup old images
            echo "ðŸ§¹ Cleaning up old Docker images..."
            docker image prune -f

      - name: Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment completed successfully"
          else
            echo "âŒ Deployment failed"
          fi

      - name: Notify via Telegram (Optional)
        if: success()
        run: |
          if [ -n "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            COMMIT_SHORT="${GITHUB_SHA:0:7}"
            CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
            curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="ðŸš€ Hokm Game deployed successfully!%0ACommit: ${COMMIT_SHORT}%0ATime: ${CURRENT_TIME}"
          fi
